# **FETCH: MASTER ARCHITECTURE**

Module B: Systems Architecture & Infrastructure  
Classification: INTERNAL / PRIVATE  
Version: 4.0.0 (The "Terrier" Revision)

# **1\. HARDWARE TOPOLOGY: THE SINGLE NODE**

**Axiom of Simplicity:** To maximize velocity and minimize network latency for the MVP, the "Monolith" architecture (Single PC) is retained but augmented with Zero Configuration Networking.

## **1.1. Node A: The Monolith (Gaming PC)**

* **Role:** The sole host for Database, API, Inference, and Orchestration.  
* **Discovery Protocol (New):**  
  * **mDNS / Zeroconf:** The server MUST broadcast \_fetch-api.\_tcp.local on port 8000\.  
  * **Hostname:** fetch-server.local.  
  * **Benefit:** The Android client connects to http://fetch-server.local:8000, eliminating hardcoded IP addresses (192.168.0.x) and static DHCP reservations.

# **2\. HYBRID MODEL ROUTING (THE CORTEX)**

Objective: Balance privacy with general intelligence.  
Implementation: The API Gateway (FastAPI) acts as a router based on the requested mode.

![Image of][image1]  
Shutterstock  
Explore

## **2.1. Routing Logic**

| Feature | Mode | Routing Path | Model | Use Case |
| :---- | :---- | :---- | :---- | :---- |
| **General Chat** | **Public** | Android \-\> FastAPI Wrapper \-\> Google AI API | **Gemini 1.5 Flash** | "What is the capital of France?", "Summarize this PDF", General Trivia. |
| **Email Drafting** | **Private** | Android \-\> FastAPI \-\> Local Ollama | **DeepSeek-R1** | "Reply to Client X", "Draft invoice", "Check availability". |
| **RAG/Context** | **Private** | Android \-\> FastAPI \-\> Local Vector DB | **all-mpnet-base-v2** | "Find emails from Bob", "When is the dentist?". |
| **Admin/System** | **System** | Android \-\> FastAPI \-\> Logic Controller | **None (Code)** | "Check Backup Health", "Set Sass Level", "Reboot Node". |

## **2.2. The Wrapper (Public Mode)**

* **Security:** The Google API Key is stored in .env on the PC. The Android client *never* sees the key.  
* **Sanitization:** The wrapper ensures no PII (Personally Identifiable Information) from the local DB is accidentally injected into the public prompt unless explicitly authorized.

# **3\. DATA SCHEMA (PostgreSQL)**

Database: fetch\_db  
Extensions: vector, uuid-ossp

## **3.1. Core Tables**

\-- 1\. EMAILS: The raw communication log \+ Embeddings  
CREATE TABLE emails (  
    id UUID PRIMARY KEY DEFAULT uuid\_generate\_v4(),  
    message\_id TEXT UNIQUE NOT NULL, \-- Gmail Message-ID header  
    thread\_id TEXT,  
    body\_hash CHAR(64) UNIQUE NOT NULL, \-- SHA-256 for Anti-Cannibalization  
    sender TEXT NOT NULL,  
    subject TEXT,  
    raw\_body TEXT, \-- Sanitized plain text  
    summary TEXT, \-- Generated by Local Llama 3.1  
    embedding VECTOR(768), \-- all-mpnet-base-v2 representation  
    received\_at TIMESTAMPTZ DEFAULT NOW(),  
    is\_processed BOOLEAN DEFAULT FALSE  
);

\-- Index for Semantic Search (HNSW)  
CREATE INDEX ON emails USING hnsw (embedding vector\_cosine\_ops);

\-- 2\. DRAFTS: The output buffer  
CREATE TABLE drafts (  
    id UUID PRIMARY KEY DEFAULT uuid\_generate\_v4(),  
    email\_id UUID REFERENCES emails(id),  
    status TEXT CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED', 'SENT')),  
    proposed\_body TEXT,  
    reasoning\_trace TEXT, \-- DeepSeek-R1's internal monologue  
    archimedes\_remark TEXT, \-- The persona's commentary  
    created\_at TIMESTAMPTZ DEFAULT NOW()  
);

\-- 3\. AI\_EXCLUSIONS: The Blacklist  
CREATE TABLE ai\_exclusions (  
    hash CHAR(64) PRIMARY KEY, \-- SHA-256  
    source TEXT DEFAULT 'GENERATED\_OUTPUT',  
    created\_at TIMESTAMPTZ DEFAULT NOW()  
);

# **4\. RAG PROTOCOL: ANTI-CANNIBALIZATION**

**Objective:** Prevent "Model Collapse" (Perplexity Degradation) caused by the AI training on its own outputs.

## **4.1. Cryptographic CAS Strategy**

Instead of relying on fragile headers (which are stripped in replies/forwards), we use **Content-Addressable Storage (CAS)** principles.

* **Ingestion Flow:**  
  1. **Normalization:** Incoming text is lowercased, whitespace-trimmed, and stripped of standard signatures.  
  2. **Hashing:** Compute SHA-256(normalized\_text).  
  3. **Gatekeeper:**  
     * Query ai\_exclusions table.  
     * If EXISTS, discard immediately. Do NOT vectorize.  
     * If NOT EXISTS, proceed to vector embedding.  
  4. **Registration:** Whenever Fetch successfully sends a draft, the hash of that draft is *immediately* inserted into ai\_exclusions.

# **5\. FUTURE HARDWARE HOOKS**

## **5.1. Financial OCR**

* **Trigger:** PDF attachment from specific domains (bank.com, utility.com).  
* **Pipeline:** pdf2image \-\> paddleocr \-\> Llama 3.1 (JSON Mode) \-\> Drafts Table.  
* **Output:** A structured "Bill Pay" card in the Android Deck.

## **5.2. Smart Home**

* **Protocol:** Home Assistant API (Local).  
* **Logic:**  
  * Fetch monitors calendar\_negotiations.  
  * If event.status \== 'Session', Fetch calls POST /api/services/light/turn\_on { "entity\_id": "light.office\_indicator", "color\_name": "red" }.